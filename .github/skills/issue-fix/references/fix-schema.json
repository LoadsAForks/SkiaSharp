{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/mono/SkiaSharp/fix-schema.json",
  "title": "SkiaSharp Bug Fix",
  "description": "Per-issue AI bug fix output v1.0. Captures root cause analysis, code changes, test results, verification, and upstream corrections. Complements ai-triage (classification) and ai-repro (reproduction) \u2014 records only what the fix step discovers.",
  "type": "object",
  "required": [
    "meta",
    "status",
    "summary",
    "rootCause",
    "changes",
    "tests",
    "verification"
  ],
  "additionalProperties": false,
  "$defs": {
    "confidence": {
      "type": "number",
      "minimum": 0,
      "maximum": 1,
      "description": "0.0-1.0 confidence score. 0.95+=explicit, 0.80-0.94=strong inference, 0.60-0.79=ambiguous, <0.60=uncertain."
    },
    "rootCauseCategory": {
      "type": "string",
      "enum": [
        "logic-error",
        "memory-safety",
        "threading",
        "api-misuse",
        "dependency",
        "upstream-skia",
        "missing-feature",
        "other"
      ],
      "description": "What kind of bug. logic-error=wrong logic/calculation. memory-safety=use-after-free/buffer overrun/disposal. threading=race condition/deadlock. api-misuse=incorrect Skia API usage in C shim. dependency=third-party library issue. upstream-skia=bug in Google's Skia. missing-feature=feature not yet exposed. other=none of the above."
    },
    "rootCauseArea": {
      "type": "string",
      "enum": [
        "managed",
        "binding",
        "native",
        "build",
        "packaging",
        "tests",
        "docs"
      ],
      "description": "Which layer of the stack. managed=C# wrapper code. binding=P/Invoke declarations. native=C API shim or Skia C++. build=build scripts/cake. packaging=NuGet/runtime packaging. tests=test infrastructure. docs=documentation only."
    },
    "changeType": {
      "type": "string",
      "enum": [
        "added",
        "modified",
        "removed"
      ],
      "description": "How the file was changed."
    },
    "riskLevel": {
      "type": "string",
      "enum": [
        "low",
        "medium",
        "high"
      ],
      "description": "low=isolated change, no ABI impact. medium=touches public API or multiple files. high=ABI change, breaking change, or broad impact."
    },
    "testResult": {
      "type": "string",
      "enum": [
        "passed",
        "failed",
        "not-run"
      ],
      "description": "passed=all tests passed. failed=test(s) failed. not-run=tests were not executed."
    },
    "reproScenarioResult": {
      "type": "string",
      "enum": [
        "passed",
        "failed",
        "not-run",
        "not-applicable"
      ],
      "description": "passed=repro scenario no longer reproduces after fix. failed=still reproduces. not-run=repro not executed. not-applicable=no repro exists."
    },
    "verificationMethod": {
      "type": "string",
      "enum": [
        "automated-test",
        "manual-repro",
        "visual-inspection",
        "code-review"
      ],
      "description": "How the fix was verified. automated-test=ran automated test suite. manual-repro=manually re-ran the reproduction scenario. visual-inspection=visually compared output. code-review=verified by reading the code change."
    },
    "prStatus": {
      "type": "string",
      "enum": [
        "draft",
        "open",
        "merged",
        "closed"
      ],
      "description": "Current PR state."
    },
    "fixStatus": {
      "type": "string",
      "enum": [
        "in-progress",
        "fixed",
        "cannot-fix",
        "needs-info",
        "duplicate"
      ],
      "description": "in-progress=still working. fixed=fix verified and PR ready/merged. cannot-fix=requires upstream change or infeasible. needs-info=blocked on missing information. duplicate=duplicate of another issue."
    },
    "correctionSource": {
      "type": "string",
      "enum": [
        "triage",
        "repro"
      ],
      "description": "Which upstream step is being corrected."
    }
  },
  "properties": {
    "meta": {
      "type": "object",
      "description": "Metadata about this fix analysis.",
      "required": [
        "schemaVersion",
        "number",
        "repo",
        "analyzedAt"
      ],
      "additionalProperties": false,
      "properties": {
        "schemaVersion": {
          "type": "string",
          "const": "1.0",
          "description": "Schema version."
        },
        "number": {
          "type": "integer",
          "minimum": 1,
          "description": "GitHub issue number."
        },
        "repo": {
          "type": "string",
          "description": "Repository in owner/name format.",
          "pattern": "^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$"
        },
        "analyzedAt": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 UTC timestamp of when fix analysis was performed."
        }
      }
    },
    "inputs": {
      "type": "object",
      "description": "Upstream pipeline files consumed by this step.",
      "additionalProperties": false,
      "properties": {
        "triageFile": {
          "type": "string",
          "description": "Relative path to ai-triage JSON if consumed, e.g. 'ai-triage/2997.json'."
        },
        "reproFile": {
          "type": "string",
          "description": "Relative path to ai-repro JSON if consumed, e.g. 'ai-repro/2997.json'."
        }
      }
    },
    "status": {
      "type": "object",
      "description": "Current status of the fix attempt.",
      "required": [
        "value",
        "reason"
      ],
      "additionalProperties": false,
      "properties": {
        "value": {
          "$ref": "#/$defs/fixStatus",
          "description": "Fix status value."
        },
        "reason": {
          "type": "string",
          "description": "One-sentence explanation of why the fix has this status. Always provided regardless of status value."
        }
      }
    },
    "summary": {
      "type": "string",
      "minLength": 20,
      "description": "One-paragraph summary of what was fixed and how. Include the root cause, the fix approach, and verification outcome."
    },
    "rootCause": {
      "type": "object",
      "description": "Root cause analysis \u2014 what was wrong and why.",
      "required": [
        "category",
        "area",
        "description"
      ],
      "additionalProperties": false,
      "properties": {
        "category": {
          "$ref": "#/$defs/rootCauseCategory",
          "description": "Classification of the bug type."
        },
        "area": {
          "$ref": "#/$defs/rootCauseArea",
          "description": "Which layer of the stack the root cause is in."
        },
        "description": {
          "type": "string",
          "minLength": 20,
          "description": "What was wrong and why. Include the specific code path and the logic error."
        },
        "confidence": {
          "$ref": "#/$defs/confidence",
          "description": "Confidence in the root cause analysis. 0.95+=verified via debugging/test. 0.80-0.94=strong evidence. <0.80=hypothesis."
        },
        "affectedFiles": {
          "type": "array",
          "items": {
            "type": "string",
            "description": "A source file path."
          },
          "description": "Source files involved in the root cause (not necessarily all changed files)."
        }
      }
    },
    "changes": {
      "type": "object",
      "description": "Code changes made to fix the issue.",
      "required": [
        "files",
        "breakingChange",
        "risk"
      ],
      "additionalProperties": false,
      "properties": {
        "files": {
          "type": "array",
          "description": "List of files modified, added, or removed.",
          "items": {
            "type": "object",
            "required": [
              "path",
              "changeType",
              "summary"
            ],
            "additionalProperties": false,
            "properties": {
              "path": {
                "type": "string",
                "description": "Relative file path from repo root."
              },
              "changeType": {
                "$ref": "#/$defs/changeType",
                "description": "How the file was changed."
              },
              "summary": {
                "type": "string",
                "description": "What changed in this file and why."
              }
            },
            "description": "A single file change."
          }
        },
        "breakingChange": {
          "type": "boolean",
          "description": "Whether the fix changes public API behavior or ABI."
        },
        "risk": {
          "$ref": "#/$defs/riskLevel",
          "description": "Risk level of the change."
        }
      }
    },
    "tests": {
      "type": "object",
      "description": "Test execution results.",
      "required": [
        "regressionTestAdded",
        "result"
      ],
      "additionalProperties": false,
      "properties": {
        "regressionTestAdded": {
          "type": "boolean",
          "description": "Whether a regression test was added for this fix."
        },
        "testsAdded": {
          "type": "array",
          "description": "New test methods added as part of this fix.",
          "items": {
            "type": "object",
            "required": [
              "file",
              "name"
            ],
            "additionalProperties": false,
            "properties": {
              "file": {
                "type": "string",
                "description": "Test file path relative to repo root."
              },
              "name": {
                "type": "string",
                "description": "Test method name."
              },
              "description": {
                "type": "string",
                "description": "What behavior this test validates."
              }
            },
            "description": "A test method added as part of the fix."
          }
        },
        "command": {
          "type": "string",
          "description": "Test command that was run."
        },
        "result": {
          "$ref": "#/$defs/testResult",
          "description": "Overall test suite result."
        }
      }
    },
    "verification": {
      "type": "object",
      "description": "Verification that the fix resolves the original issue.",
      "required": [
        "reproScenario",
        "method"
      ],
      "additionalProperties": false,
      "properties": {
        "reproScenario": {
          "$ref": "#/$defs/reproScenarioResult",
          "description": "Whether the original repro scenario still reproduces after the fix."
        },
        "method": {
          "$ref": "#/$defs/verificationMethod",
          "description": "How the fix was verified."
        },
        "notes": {
          "type": "string",
          "description": "How verification went \u2014 what was tested and what the outcome was."
        }
      }
    },
    "blockers": {
      "type": "array",
      "items": {
        "type": "string",
        "description": "A specific reason the fix is blocked."
      },
      "minItems": 1,
      "description": "Specific reasons the fix is blocked. Required when status is cannot-fix or needs-info. Each item is one actionable blocker."
    },
    "pr": {
      "type": "object",
      "description": "Pull request created for this fix.",
      "required": [
        "url",
        "status"
      ],
      "additionalProperties": false,
      "properties": {
        "number": {
          "type": "integer",
          "minimum": 1,
          "description": "PR number."
        },
        "url": {
          "type": "string",
          "format": "uri",
          "description": "PR URL."
        },
        "status": {
          "$ref": "#/$defs/prStatus",
          "description": "Current PR state."
        }
      }
    },
    "feedback": {
      "type": "object",
      "description": "Feedback on upstream pipeline steps.",
      "additionalProperties": false,
      "properties": {
        "corrections": {
          "type": "array",
          "items": {
            "type": "object",
            "required": [
              "source",
              "topic",
              "upstream",
              "corrected"
            ],
            "additionalProperties": false,
            "properties": {
              "source": {
                "$ref": "#/$defs/correctionSource",
                "description": "Which upstream step is being corrected."
              },
              "topic": {
                "type": "string",
                "description": "What category of finding was corrected, e.g. 'classification', 'scope', 'root-cause', 'affected-platforms'."
              },
              "upstream": {
                "type": "string",
                "description": "What the upstream step (triage or repro) said or concluded."
              },
              "corrected": {
                "type": "string",
                "description": "What the fix step actually found to be true."
              }
            },
            "description": "A single correction to an upstream finding."
          },
          "description": "Corrections to findings from triage or repro steps."
        }
      }
    },
    "relatedIssues": {
      "type": "array",
      "items": {
        "type": "integer",
        "minimum": 1,
        "description": "A GitHub issue number."
      },
      "description": "Other GitHub issue numbers related to or fixed by the same PR."
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "status": {
            "properties": {
              "value": {
                "enum": [
                  "cannot-fix",
                  "needs-info"
                ]
              }
            }
          }
        },
        "required": [
          "status"
        ]
      },
      "then": {
        "required": [
          "meta",
          "status",
          "summary",
          "rootCause",
          "changes",
          "tests",
          "verification",
          "blockers"
        ]
      }
    },
    {
      "if": {
        "properties": {
          "status": {
            "properties": {
              "value": {
                "const": "fixed"
              }
            }
          }
        },
        "required": [
          "status"
        ]
      },
      "then": {
        "required": [
          "meta",
          "status",
          "summary",
          "rootCause",
          "changes",
          "tests",
          "verification",
          "pr"
        ]
      }
    },
    {
      "if": {
        "properties": {
          "status": {
            "properties": {
              "value": {
                "const": "duplicate"
              }
            }
          }
        },
        "required": [
          "status"
        ]
      },
      "then": {
        "required": [
          "meta",
          "status",
          "summary",
          "rootCause",
          "changes",
          "tests",
          "verification",
          "relatedIssues"
        ],
        "properties": {
          "relatedIssues": {
            "minItems": 1
          }
        }
      }
    }
  ]
}
